{% extends 'base.html' %}

{% block title %}إنشاء استطلاع جديد - منصة التصويت{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow-lg fade-in">
            <div class="card-header text-center">
                <h4 class="mb-0">
                    <i class="fas fa-plus-circle ms-2"></i>
                    إنشاء استطلاع جديد
                </h4>
                <p class="mb-0 mt-2 text-white-50">قم بإنشاء استطلاع جديد للمستخدمين</p>
            </div>
            <div class="card-body">
                <form method="post" id="createPollForm">
                    {% csrf_token %}
                    
                    <!-- Poll Basic Information -->
                    <div class="section-header mb-4">
                        <h5 class="section-title">
                            <i class="fas fa-info-circle ms-2 text-primary"></i>
                            معلومات الاستطلاع
                        </h5>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="title" class="form-label">
                                <i class="fas fa-heading ms-2"></i>عنوان الاستطلاع <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="title" name="title" 
                                   placeholder="أدخل عنوان الاستطلاع" required maxlength="200">
                            <div class="form-text">عنوان واضح ومختصر للاستطلاع</div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-12">
                            <label for="description" class="form-label">
                                <i class="fas fa-align-left ms-2"></i>وصف الاستطلاع (اختياري)
                            </label>
                            <textarea class="form-control" id="description" name="description" 
                                      rows="3" placeholder="وصف تفصيلي للاستطلاع (اختياري)"></textarea>
                            <div class="form-text">معلومات إضافية حول الاستطلاع</div>
                        </div>
                    </div>
                    
                    <!-- Poll Timing -->
                    <div class="section-header mb-4">
                        <h5 class="section-title">
                            <i class="fas fa-clock ms-2 text-warning"></i>
                            توقيت الاستطلاع
                        </h5>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="start_time" class="form-label">
                                <i class="fas fa-play ms-2"></i>تاريخ ووقت البداية <span class="text-danger">*</span>
                            </label>
                            <input type="datetime-local" class="form-control" id="start_time" name="start_time" required>
                            <div class="form-text">متى يبدأ التصويت</div>
                        </div>
                        <div class="col-md-6">
                            <label for="end_time" class="form-label">
                                <i class="fas fa-stop ms-2"></i>تاريخ ووقت النهاية <span class="text-danger">*</span>
                            </label>
                            <input type="datetime-local" class="form-control" id="end_time" name="end_time" required>
                            <div class="form-text">متى ينتهي التصويت</div>
                        </div>
                    </div>

                    <!-- Poll Type Selection -->
                    <div class="section-header mb-4">
                        <h5 class="section-title">
                            <i class="fas fa-vote-yea ms-2 text-info"></i>
                            نوع الاستطلاع
                        </h5>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="poll_type" id="team_poll" value="team" checked>
                                <label class="form-check-label" for="team_poll">
                                    <i class="fas fa-users me-2"></i>
                                    تصويت بين اللوائح
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="poll_type" id="custom_poll" value="custom">
                                <label class="form-check-label" for="custom_poll">
                                    <i class="fas fa-list me-2"></i>
                                    خيارات مخصصة
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Team Selection (for team polls) -->
                    <div id="teamSection" class="section-header mb-4">
                        <h5 class="section-title">
                            <i class="fas fa-users ms-2 text-success"></i>
                            اختيار اللوائح للتصويت
                        </h5>
                        
                        {% if available_teams %}
                        <div class="row mt-3">
                            {% for team in available_teams %}
                            <div class="col-md-6 mb-3">
                                <div class="card team-card">
                                    <div class="card-body">
                                        <div class="form-check">
                                            <input class="form-check-input team-checkbox" type="checkbox" 
                                                   name="selected_teams" value="{{ team.id }}" id="team_{{ team.id }}">
                                            <label class="form-check-label w-100" for="team_{{ team.id }}">
                                                <div class="d-flex align-items-center">
                                                    {% if team.image %}
                                                    <img src="{{ team.image.url }}" class="team-thumb me-3" alt="{{ team.name }}">
                                                    {% else %}
                                                    <div class="team-thumb-placeholder me-3">
                                                        <i class="fas fa-users"></i>
                                                    </div>
                                                    {% endif %}
                                                    <div>
                                                        <h6 class="mb-1">{{ team.name }}</h6>
                                                        <small class="text-muted">{{ team.description|truncatewords:10|default:"" }}</small>
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <div class="alert alert-info mt-3">
                            <i class="fas fa-info-circle me-2"></i>
                            اختر فريقين على الأقل للمشاركة في التصويت
                        </div>
                        {% else %}
                        <div class="alert alert-warning mt-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            لا توجد لوائح  نشطة متاحة. يجب <a href="{% url 'create_team' %}" class="alert-link">إنشاء لوائح </a> أولاً قبل إنشاء استطلاع بين اللوائح.
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Custom Options (for custom polls) -->
                    <div id="customSection" class="section-header mb-4" style="display: none;">
                        <h5 class="section-title">
                            <i class="fas fa-list ms-2 text-success"></i>
                            خيارات التصويت المخصصة
                        </h5>
                        
                        <div id="optionsContainer" class="mt-3">
                            <!-- Option 1 -->
                            <div class="option-group mb-3">
                                <label class="form-label">
                                    <i class="fas fa-check ms-2"></i>الخيار 1 <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">1</span>
                                    <input type="text" class="form-control" name="options" placeholder="أدخل نص الخيار الأول">
                                </div>
                            </div>
                            
                            <!-- Option 2 -->
                            <div class="option-group mb-3">
                                <label class="form-label">
                                    <i class="fas fa-check ms-2"></i>الخيار 2 <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">2</span>
                                    <input type="text" class="form-control" name="options" placeholder="أدخل نص الخيار الثاني">
                                </div>
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn-outline-primary" id="addOptionBtn" onclick="addOption()">
                            <i class="fas fa-plus ms-2"></i>إضافة خيار
                        </button>
                    </div>
                    
                    <!-- Poll Preview -->
                    <div class="card poll-preview mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-eye ms-2"></i>معاينة الاستطلاع
                            </h6>
                        </div>
                        <div class="card-body">
                            <h5 id="previewTitle" class="mb-2">عنوان الاستطلاع سيظهر هنا</h5>
                            <p id="previewDescription" class="text-muted">وصف الاستطلاع سيظهر هنا</p>
                            <div id="previewOptions">
                                <div class="text-muted small">خيارات التصويت ستظهر هنا</div>
                            </div>
                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="fas fa-calendar ms-2"></i>
                                    <span id="previewTiming">التوقيت سيظهر هنا</span>
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Submit Buttons -->
                    <div class="row">
                        <div class="col-md-4 mb-2">
                            <button type="submit" name="action" value="schedule_poll" class="btn btn-primary btn-lg w-100">
                                <i class="fas fa-check ms-2"></i>
                                جدولة الاستطلاع
                            </button>
                        </div>
                        <div class="col-md-4 mb-2">
                            <button type="submit" name="action" value="save_draft" class="btn btn-info btn-lg w-100">
                                <i class="fas fa-save ms-2"></i>
                                حفظ كمسودة
                            </button>
                        </div>
                        <div class="col-md-4">
                            <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-secondary btn-lg w-100">
                                <i class="fas fa-times ms-2"></i>
                                إلغاء
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .section-header {
        border-bottom: 2px solid rgba(37, 99, 235, 0.1);
        padding-bottom: 0.5rem;
    }

    .section-title {
        color: var(--text-dark);
        font-weight: 600;
        margin-bottom: 0;
    }

    .team-card {
        transition: all 0.3s ease;
        border: 2px solid transparent;
        cursor: pointer;
    }

    .team-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .team-card.selected {
        border-color: var(--primary-blue);
        background-color: rgba(37, 99, 235, 0.05);
    }

    .team-thumb {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 8px;
    }

    .team-thumb-placeholder {
        width: 50px;
        height: 50px;
        background: #f8f9fa;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6c757d;
    }

    .poll-preview {
        border: 2px dashed rgba(37, 99, 235, 0.3) !important;
        transition: all 0.3s ease;
    }

    .poll-preview:hover {
        border-color: var(--primary-blue) !important;
        background: rgba(37, 99, 235, 0.05) !important;
    }

    .form-check-input:checked ~ .form-check-label .team-card {
        border-color: var(--primary-blue);
        background-color: rgba(37, 99, 235, 0.05);
    }

    .option-group {
        transition: all 0.3s ease;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    let optionCount = 2;
    const maxOptions = 5;

    // Toggle between team and custom poll types
    document.addEventListener('DOMContentLoaded', function() {
        const teamRadio = document.getElementById('team_poll');
        const customRadio = document.getElementById('custom_poll');
        const teamSection = document.getElementById('teamSection');
        const customSection = document.getElementById('customSection');

        function togglePollType() {
            if (teamRadio.checked) {
                teamSection.style.display = 'block';
                customSection.style.display = 'none';
            } else {
                teamSection.style.display = 'none';
                customSection.style.display = 'block';
            }
            updatePreview();
        }

        teamRadio.addEventListener('change', togglePollType);
        customRadio.addEventListener('change', togglePollType);

        // Team selection handling
        document.querySelectorAll('.team-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const card = this.closest('.team-card');
                if (this.checked) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
                updatePreview();
            });
        });

        // Initialize preview
        updatePreview();
        
        // Set minimum start time to current time
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('start_time').min = now.toISOString().slice(0, 16);
        
        // Event listeners for preview updates
        document.getElementById('title').addEventListener('input', updatePreview);
        document.getElementById('description').addEventListener('input', updatePreview);
        document.getElementById('start_time').addEventListener('change', updatePreview);
        document.getElementById('end_time').addEventListener('change', updatePreview);
    });

    // Add custom option
    function addOption() {
        if (optionCount >= maxOptions) {
            alert('يمكنك إضافة 5 خيارات كحد أقصى');
            return;
        }

        optionCount++;
        const optionsContainer = document.getElementById('optionsContainer');
        const newOption = document.createElement('div');
        newOption.className = 'option-group mb-3';
        newOption.innerHTML = `
            <label class="form-label">
                <i class="fas fa-check ms-2"></i>الخيار ${optionCount}
            </label>
            <div class="input-group">
                <span class="input-group-text">${optionCount}</span>
                <input type="text" class="form-control" name="options" placeholder="أدخل نص الخيار ${optionCount}">
                <button class="btn btn-outline-danger" type="button" onclick="removeOption(this)">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        
        optionsContainer.appendChild(newOption);
        
        // Add event listener for preview update
        newOption.querySelector('input').addEventListener('input', updatePreview);
        
        if (optionCount >= maxOptions) {
            document.getElementById('addOptionBtn').style.display = 'none';
        }
        
        updatePreview();
    }

    // Remove custom option
    function removeOption(button) {
        const optionGroup = button.closest('.option-group');
        optionGroup.remove();
        optionCount--;
        
        // Renumber remaining options
        const remainingOptions = document.querySelectorAll('#optionsContainer .option-group');
        remainingOptions.forEach((option, index) => {
            const number = index + 1;
            option.querySelector('.form-label').innerHTML = `<i class="fas fa-check ms-2"></i>الخيار ${number}`;
            option.querySelector('.input-group-text').textContent = number;
            option.querySelector('input').placeholder = `أدخل نص الخيار ${number}`;
        });
        
        if (optionCount < maxOptions) {
            document.getElementById('addOptionBtn').style.display = 'block';
        }
        
        updatePreview();
    }

    // Update preview
    function updatePreview() {
        const title = document.getElementById('title').value || 'عنوان الاستطلاع سيظهر هنا';
        const description = document.getElementById('description').value || 'وصف الاستطلاع سيظهر هنا';
        const startTime = document.getElementById('start_time').value;
        const endTime = document.getElementById('end_time').value;
        const pollType = document.querySelector('input[name="poll_type"]:checked').value;
        
        document.getElementById('previewTitle').textContent = title;
        document.getElementById('previewDescription').textContent = description;
        
        // Update options preview
        const optionsContainer = document.getElementById('previewOptions');
        let optionsHTML = '';
        
        if (pollType === 'team') {
            const selectedTeams = document.querySelectorAll('.team-checkbox:checked');
            selectedTeams.forEach((checkbox, index) => {
                const label = checkbox.nextElementSibling.querySelector('h6').textContent;
                optionsHTML += `
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" disabled>
                        <label class="form-check-label">${label}</label>
                    </div>
                `;
            });
        } else {
            const optionInputs = document.querySelectorAll('#customSection input[name="options"]');
            optionInputs.forEach((input, index) => {
                if (input.value.trim()) {
                    optionsHTML += `
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" disabled>
                            <label class="form-check-label">${input.value}</label>
                        </div>
                    `;
                }
            });
        }
        
        if (optionsHTML) {
            optionsContainer.innerHTML = optionsHTML;
        } else {
            optionsContainer.innerHTML = '<div class="text-muted small">خيارات التصويت ستظهر هنا</div>';
        }
        
        // Update timing preview
        if (startTime && endTime) {
            const start = new Date(startTime).toLocaleString('ar-SA');
            const end = new Date(endTime).toLocaleString('ar-SA');
            document.getElementById('previewTiming').textContent = `من ${start} إلى ${end}`;
        } else {
            document.getElementById('previewTiming').textContent = 'التوقيت سيظهر هنا';
        }
    }

    // Form validation
    document.getElementById('createPollForm').addEventListener('submit', function(e) {
        const title = document.getElementById('title').value.trim();
        const startTime = document.getElementById('start_time').value;
        const endTime = document.getElementById('end_time').value;
        const pollType = document.querySelector('input[name="poll_type"]:checked').value;
        
        // Basic validation
        if (!title || !startTime || !endTime) {
            e.preventDefault();
            alert('عنوان الاستطلاع وتوقيت البداية والنهاية مطلوبة');
            return false;
        }
        
        if (endTime <= startTime) {
            e.preventDefault();
            alert('وقت النهاية يجب أن يكون بعد وقت البداية');
            return false;
        }
        
        // Poll type specific validation
        if (pollType === 'team') {
            const selectedTeams = document.querySelectorAll('.team-checkbox:checked');
            if (selectedTeams.length < 2) {
                e.preventDefault();
                alert('يجب اختيار فريقين على الأقل للتصويت');
                return false;
            }
        } else {
            const filledOptions = Array.from(document.querySelectorAll('#customSection input[name="options"]'))
                .filter(input => input.value.trim());
            
            if (filledOptions.length < 2) {
                e.preventDefault();
                alert('يجب إضافة خيارين على الأقل للاستطلاع');
                return false;
            }
        }
        
        return true;
    });
</script>
{% endblock %}